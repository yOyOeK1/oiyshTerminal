<!DOCTYPE html>
<!--
check libs:
https://www.movable-type.co.uk/scripts/geodesy-library.html

geo library and ais encode/decode
https://github.com/fulup-bzh/GeoGate/blob/master/encoder/lib/GG-AisEncode.js

-->

<html lang="en">

<head>
  <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ySS</title>
  <link rel="icon" type="image/x-icon" href="icons/favicon.png">



<script>
  /*
var mod = {};
class moduleCollector{

  conntructor (){

  }

  set exports( a ){
    console.log("moduleCollector gos some");
    console.log(a.name);
    mod[ a.name ] = a;

  }

  getModule( name ){
    console.log(" getModule ! - name "+name);
    return mod[name];
  }

}
var module = new moduleCollector();
*/
//var t4y;
</script>

<!-- noderedinjectpoint -->
<script src="s_nodeRedSupport.js"></script>
<script src="index.js"></script>

<!-- ap playground area START-->
<!--
<script src="apSimulator.js"></script>
<script src="apV3.js"></script>

<script src="apML5v1.js"></script>

<script src="PID2.js"></script>

<script src="brain.js"></script>
<script src="apVPID.js"></script>
<script src="apVPID2.js"></script>
<script src="apVPID2.2.js"></script>
<script src="apVBrain2.js"></script>
-->
<!-- ap playground area END -->
<script src="libs/raphael-2.1.4.min.js"></script>
<script src="libs/justgage.js"></script>
<!--<script src="libs/ml5.min.js"></script>-->
<script src="libs/kalman.min.js"></script>
<script src="libs/d3.v4.js"></script>
<script src="libs/svg.min.js"></script>
<script src="libs/SM.js"></script>
<script src="libs/PID2.js"></script>
<script src="libs/m_d3Plot.js"></script>
<script src="libs/m_MyJustGage.js"></script>
<script src="libs/sPager.js"></script>
<script src="libs/mShaders.js"></script>
<script src="libs/mMath.js"></script>
<script src="libs/mApp.js"></script>
<script src="libs/mDoCmd.js"></script>
<script src="libs/mWebSockets.js"></script>
<script src="libs/aggregation.js"></script>
<script src="libs/mOperation.js"></script>

<script src="libs/jquery.min.js"></script>
<script src="libs/jquery-ui.js"></script>
<script src="libs/jquery.mobile-1.4.5.min.js"></script>

<script type="importmap">
    {
        "imports": {
            "Three4Yss": "./libs/three4yss.js",
            "Three4YssModule": "./libs/three4yssModule.mjs",
            "three": "./three/three.module.js",
            "OrbitControls": "./three/jsm/controls/OrbitControls.js",
            "GLTFLoader": "./three/jsm/loaders/GLTFLoader.js",
            "RGBELoader": "./three/jsm/loaders/RGBELoader.js",
            "FontLoader": "./three/jsm/loaders/FontLoader.js",
            "SVGLoader":  "./three/jsm/loaders/SVGLoader.js",
            "EffectComposer": "./three/jsm/postprocessing/EffectComposer.js",
            "RenderPass": "./three/jsm/postprocessing/RenderPass.js",
            "GlitchPass": "./three/jsm/postprocessing/GlitchPass.js",
            "ShaderPass": "./three/jsm/postprocessing/ShaderPass.js",
            "OutlinePass": "./three/jsm/postprocessing/OutlinePass.js",

            "T4y_putText": "./libs/t4y_putText.js",
            "T4y_shadersDefs": "./libs/t4y_shadersDefs.js",
            "T4y_shader": "./libs/t4y_shader.js",
            "T4y_ani": "./libs/t4y_ani.js",
            "T4y_console": "./libs/t4y_console.js"
        }
    }
</script>
<script type="module" src="./three4yssModule.mjs"></script>

<script src="libs/jquery.flexslider.js"></script>
<link rel="stylesheet" href="libs/flexslider.css" type="text/css" media="all">

<link rel="stylesheet" href="libs/jquery.mobile-1.4.5.min.css">
<link rel="stylesheet" href="main.css">


<!--
<script>
  console.log("pre module exec test 1... :)");
</script>
<script type="module">
console.log("module exec test 1... :)");
</script>
<script>
  console.log("pre module exec test 1... :)");
</script>

<script type="module">
import { Three4Yss } from "./libs/three4yss.js";
console.log("Three4Yss loaded... :)");
if( t4y == 0 ){
  t4y = new Three4Yss();

}else
  console.log("reinit Three4Yss ? ...");
</script>

<script type="module" src="./libs/three4yssModule.js"></script>
-->

<script>
var urlArgs = {};
var waitCount = 0;
function waitForT4y(){
  cl("waiting for ty4...."+waitCount++);
  cl(t4y);

  if( 0 && waitCount == 20 ){
    //$.getScript("./libs/three4yss.js");
    var tagt4y = document.createElement("script");
    tagt4y.type = 'module';
    tagt4y.src = "./three4yssModule.mjs";
    document.getElementsByTagName("head")[0].appendChild(tagt4y);
    console.log("FORCE LOAD ! three 4 yss");
    //var scriptElement=document.createElement('script');
    //scriptElement.src = "libs/three4yss.js";
    //document.head.appendChild(scriptElement);
  }

  if( waitCount >= 2 ){
    cl("Three4Yss:");
    try{
      cl(Three4Yss);

    }catch(e){
      cl("no Three4Yss");
    }
  }

  if( t4y != 0 || waitCount > 5 )
    makeInit();
  else
    setTimeout(waitForT4y,1000);
}

// ON LOAD ------------------
$( document ).ready(function() {

  //makeInit();
  waitForT4y();
});
function makeInit(){
  /*
  console.log("loading .... mOperation");
  jQuery.ajax({
      url: "libs/mOperation.js",
      dataType: "script",
      cache: true
  }).done(function() {
      console.log("  mOperation DONE");
      doRest();
  });
  */

  cl("-----------------------------------");
  cl("t4y status:");
  cl(t4y);

  jQuery.fx.interval = Math.round(1000/18);
  console.log("yss index.html document ready !");
  pager = new sPager();
  try{
    //cl("current yssPages setting is ----------------");
    //yssPages.find(p=>{
    //  cl(p);
    //  cl("      -------------------------");
    //});
    //cl("current yssPages setting is ----------------END");
    nodeRedInjectionAddPages();
  }catch(e){
    //pager.addPage( new s_calibrationPage() );
    //pager.addPage( new s_basicSailPage() );
    cl("nodeRedInjectionAddPages() not pressent running on grafana not node-red?");
    cl(e);
  }
  // basic test of functions on svg version
  //pager.addPage( new s_testFuncsPage() );
  // basic test of functions on three.js glb models
  //pager.addPage( new s_threeTestPage() );

  // screen manager remote
  sm = new SM();
  pager.setScreenManager(sm);
  pager.addPage( sm );

  if( doneFlag++ == 1 ){
    cl("ready! abord double init ?");
    return 0;
  }
	cl( "ready!" );

  //doMqtt();
  svgTests();
	wsConnectIn( pager );
	wsConnectOut();
	pager.getPage( -1 );


  // store last sean page on browser
  var lastUse = document.cookie;
  cl("have cookie from last use: ["+lastUse+"]");
  var lastPageNo = getCookie('lastPage');
  cl("lastPage: ["+lastPageNo+"]")
  if( lastPageNo != "" )
    pager.setPage( parseInt( lastPageNo ) );
  looperIter();
  navBatteryPercentSignUp( pager );

  console.log("mouseup set times");
  $(".bottomPanelHandle").mouseup( function(){
    $("#panelMenu").panel("open");
  });

  $( window ).resize( function(){
    setSvgFit()
  });

  setSvgFit();

  window.addEventListener('hashchange', function () {
    chkUrl();
  });
  chkUrl();

}

function chkUrl(){
  var has = window.location.href;
  cl("chkUrl ["+has+"]");
  urlArgs = {};
  cl("looking for hash -------------------------");
  has = has.split("#")[1];
  if( has != undefined && has.length > 0 ){
    has = has.split("&");
    for( var h=0,hc=has.length; h<hc; h++ ){
      var t = has[h].split('=');
      if( t[0] != "" )
        urlArgs[ t[0] ] = decodeURI(t[1]);
    }

  }
  cl("urlArgs");
  cl(urlArgs);

  if( urlArgs['page'] != undefined )
    pager.setPage( urlArgs['page'] );

  else if( urlArgs['pageByName'] != undefined ){

      var n = undefined;
      for( var p=0,pc=pager.pages.length; p<pc; p++){
        if( pager.pages[p].getName == urlArgs['pageByName'] ){
          n = pager.pages[p];
          break;
        }
      }
      cl("get n ");
      cl(n);

      pager.setPage( pager.pages.indexOf( n ) );
  }

}

</script>
</head>
<body id="mainBodyOfySS">
<!--
  ontouchstart="getTagname('start', event)"
  ontouchend="getTagname('end', event)"
  ontouchmove="getTagname('move', event)"
-->



<div id="justGuageTmp"></div>

<div id="divForJsSrc"></div>
  <!--
	<div style="display:none;position:absolute;top:200;">
		test start: <br>
		<input type="button" value="heel 0" onclick="rotateImage($('#heelI'),0.1)" >
		<input type="button" value="heel 90" onclick="rotateImage($('#heelI'),90)" >
		<input type="button" value="send ws msg" onclick="sOutSend(1)" >
		<div id="sliRotTest" width="200" height="50"></div>
		test end<br>
	</div>
-->
<div id="SMIdentDiv" style="z-index:10;position:relative;top:0;left:0;font-size:50vw;text-shadow: 5px 5px 10px #777777;display:none;"></div>
<div data-role="page">

  <!--<div data-role="popup" id="SMIdentPop" data-overlay-theme="b" data-theme="b" data-dismissible="false" style="max-width:400px;">
    <div id="SMIdentDiv" style="z-index:10;position:relative;top:0;left:0;font-size:70vw;text-shadow: 5px 5px 10px #777777;display:none;"></div>
  </div>-->


  <div
    data-role="panel"
    data-display="overlay"
    id="panelMenu">


    <ul data-role="listview" data-theme="d" id="menuListView">
      <li data-role="list-divider">

        <div class="ui-field-contain">
          <fieldset data-role="controlgroup" data-type="horizontal">
            <legend>Shaders:</legend>

            <button title="full screen"
              onclick="mkfullscreen()">
              <img src="./icons/fullscreen.svg">‎
            </button>

            <button title="invert" id="mBtShaInv"
              onclick="mkShader('invert')">
              <img src="./icons/arrow-down-up.svg">‎
            </button>

            <button title="black red" id="mBtShaBlaRed"
              onclick="mkShader('blackRed')">
              <img src="./icons/moon-stars.svg">‎
            </button>

            <button title="normal"
              onclick="mkShader('normal')">
              <img src="./icons/journal-check.svg">‎
            </button>

            <button title="Screens manager"
              onclick="sm.startIt()">
              <img src="./icons/cast.svg">‎
            </button>

            <button title="rotate"
              onclick="mkShader('rotate')">
              <img src="./icons/bootstrap-reboot.svg">‎
            </button>




          </fieldset>
        </div>

      </li>
      <!--
      <li><a href="#" data-rel="close">Cat</a></li>
      <li><a href="#" data-rel="close">Dog</a></li>
      <li><a href="#" data-rel="close">Rabbit</a></li>
      <li><a href="#" data-rel="close">Guinea Pig</a></li>
      <li><a href="#" data-rel="close">Parrot</a></li>
      -->
      <li data-theme="b" data-rel="close" class="innerMenuList"
        onclick="$('#panelMenu').panel('close');">Cancel</li>
    </ul>


  </div>

</div>

<!--
<button class="ui-btn ui-btn-icon-right ui-icon-carat-r">ok</button>
<img src="https://www.example.com/sun.jpg" alt="Sun" width="256" height="256">
-->

  <!--<div id="svgSizing" style="z-index:20;position:absolute;top:0;left:0;"></div>-->
	<div id="svgDyno" data-enhance="false" data-role="none" style="display:inline;">--</div>
  <div id="htmlDyno" style="z-index:3;position:absolute;top:0;left:0;">
<div style="text-align: center;">
  <img src="images/otWorld1.png"><br>
  <h1>oiyshTerminal - ySS_calibration</h1>
  More about on: <a href="https://github.com/yOyOeK1/oiyshTerminal">github</a>
  <br>
  <br>
  use bottom menu to start...

  <footer>ver: 2301091425</footer>

</div>

    <!--
    <button onclick='otdm({ "dganById": "*", "oFile": "/data/data/com.termux/files/home/node2otdmTools.fifo"} );'>do query to otdm</button>
    <div id="otdmResDyno"></div>
    -->
  </div>
	<div class="bottomPanel">
		<div class="bottomPanelHandle"><img id="bottomPanelMenuImg" src="images/menu.svg"></div>
		<div class="bottomPanelContainer defBg">
			io:[<span id="wsInStat">?</span>/<span id="wsOutStat">out?</span>]
      No:[<span id="SMNo">?</span>]
			<!--
      <input type="button" value="On" onclick="sOutSend('action:on')" >
			<input type="button" value="Off" onclick="sOutSend('action:off')" >
      -->
      <!--
      <button class="ui-button ui-widget ui-corner-all ui-button-icon-only"
        title="Menu"
        onclick="pager.setPage(-1);$('.bottomPanelContainer').hide()">
        <span class="ui-icon ui-icon-gear"></span>Menu
      </button>
      -->
      <!--
      <button title="Menu"
        onclick="pager.setPage(-1);$('.bottomPanelContainer').hide()">
        <img src="./icons/list.svg">
      </button>
      -->
      <!--<input type="button" value="Menu" onclick="pager.setPage(-1);$('.bottomPanelContainer').hide()">-->

      <!--
      <button title="full screen"
        onclick="mkfullscreen()">
        <img src="./icons/fullscreen.svg">
      </button>
      -->
      <!--<input type="button" value="full screen" onclick="mkfullscreen()" >-->

      <button title="invert"
        onclick="mkShader('invert')">
        <img src="./icons/arrow-down-up.svg">
      </button>
      <!--<input type="button" value="invert" onclick="mkShader('invert')" >-->

      <button title="black red"
        onclick="mkShader('blackRed')">
        <img src="./icons/moon-stars.svg">
      </button>
      <!--<input type="button" value="black red" onclick="mkShader('blackRed')" >-->

      <button title="normal"
        onclick="mkShader('normal')">
        <img src="./icons/journal-check.svg">
      </button>
      <!--<input type="button" value="normal" onclick="mkShader('normal')" >-->

      <button title="Screens manager"
        onclick="sm.startIt()">
        <img src="./icons/cast.svg">
      </button>
      <!--<input type="button" value="SM" onclick="sm.startIt()" ><br>-->

      <button title="rotate"
        onclick="mkShader('rotate')">
        <img src="./icons/bootstrap-reboot.svg">
      </button>
      <!--<input type="button" value="R" onclick="mkShader('rotate')" >-->

		</div>
	</div>
</body>

</html>
